---
title: "230221_liver_sex_specific_com"
author: "Jennifer Fisher"
date: "2023-02-21"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# START 
    Goal/Purpose of operations: 
    I am going to be looking at the results from Alpaca for the sex-specific networks across the 43 different tissue s
    
    Finished psedocode on:
    230206
    
    System which operations were done on: 
    my laptop
    
    GitHub Repo:
    Sex_Bias_Adverse_Events
    
    Directory of operations:
    ~/Documents/Sex_Bias_Adverse_Events
    
    Scripts being edited for operations:
    NA
    
    Data being used:
    output/alpaca/alpaca_runs
    
    Papers and tools: 
    NA

# STEPS

### Set working directory 

```{r}
library(gprofiler2)
library(viridis)
library(RColorBrewer)
library(ComplexHeatmap)
library(netZooR)
library(ggplot2)
```


```{r}
Liver_M_panda <- readRDS("~/output/alpaca/sex_specific_networks/Liver_M_panda.rds")
Liver_F_panda <- readRDS("~/output/alpaca/sex_specific_networks/Liver_F_panda.rds")
Liver__male_female_long <- readRDS("~/output/alpaca/alpaca_adjusted_inputs/Liver__topNet_regnet_male_female_long.rds")
```

look at the differential degrees 
```{r}
diff_genes_liver <- calcDegreeDifference(Liver_F_panda, Liver_M_panda, type = "gene")
```

```{r}
drug_genes <- c("ADH1A"	,"ADH1B", "ADH1C", "ADH4",	"ADH5",	"ADH6",	"ADH7",	
                "ALDH1A3",	"ALDH3A1",	"ALDH3B1", "ALDH3B2", "AOX1", "CYP1A2",
                "CYP2A13", "CYP2A6", "CYP2A7",	"CYP2B6",	"CYP2C18",	"CYP2C19",
                "CYP2C8",	"CYP2C9",	"CYP2D6",	"CYP2E1",	"CYP3A4",	"CYP3A43",	"CYP3A5",
                "CYP3A7",	"FMO1",	"FMO2",	"FMO3", "FMO4",	"FMO5",  "GSTA1", "GSTA2", 	"GSTA3",	"GSTA4",
                "GSTA5",	"GSTK1",	"GSTM1",	"GSTM2",	"GSTM3",	"GSTM4",	"GSTM5",	"GSTO1",
                "GSTO2",	"GSTP1",	"GSTT1",	"GSTT2",	"GSTZ1",	"MAOA",	"MAOB",	"MGST1",
                "MGST2",	"MGST3",	"UGT1A1",	"UGT1A10",	"UGT1A3",	"UGT1A4",
                "UGT1A5",	"UGT1A6",	"UGT1A7",	"UGT1A8", "UGT1A9",	"UGT2A1",	"UGT2A3", "UGT2B10",
                "UGT2B11",	"UGT2B15",	"UGT2B17",	"UGT2B28",	"UGT2B4",	"UGT2B7")
```

```{r}
diff_drug_genes_liver <- diff_genes_liver[names(diff_genes_liver) %in% drug_genes]
```

```{r}
diff_other_genes_liver <- diff_genes_liver[!names(diff_genes_liver) %in% drug_genes]
```

```{r}
diff_all_genes_liver<- rbind(data.frame(gene_list =rep( "Drug\nMetabolism", length(diff_drug_genes_liver)), Gene_Degree_Diff= as.numeric(diff_drug_genes_liver)), data.frame(gene_list =rep( "Other", length(diff_other_genes_liver)), Gene_Degree_Diff= as.numeric(diff_other_genes_liver)))
```


```{r}
res <- wilcox.test(diff_drug_genes_liver , diff_other_genes_liver  )
label_tissue <- paste("Wilcoxon signed\nrank test\np-value =\n",  res$p.value, sep = " ")
```


```{r}
diff_all_genes_liver$gene_list<- factor(diff_all_genes_liver$gene_list, levels= c("Other","Drug\nMetabolism" ))
ggplot(diff_all_genes_liver, aes(x=Gene_Degree_Diff, y= gene_list, fill = gene_list)) + geom_violin() +geom_point() +geom_text(y="Drug\nMetabolism", x=-250, label= label_tissue, size= 6) +xlab("Degree Difference (FEMALE-MALE)") + ylab("Genes")  + scale_fill_viridis( alpha=0.7, option= "H" ,discrete = TRUE)+theme(text = element_text(size = 30,  face="bold"))+ theme(legend.position = "none")
```


```{r}
drug_target_diff_analysis<- function(tissue, path){
  male_file<- paste0("~/output/alpaca/sex_specific_networks/", tissue, "_M_panda.rds")
  M_panda <- readRDS(male_file)
  female_file<- paste0("~/output/alpaca/sex_specific_networks/", tissue, "_F_panda.rds")
  F_panda <- readRDS(female_file)
  
  diff_genes <- calcDegreeDifference( F_panda , M_panda, type="gene", filter = TRUE)
  
  #save degree in here
  #panda_in_degree
  #file<- paste(path, "panda_in_degree/", tissue, "_sex_degree_gene.rds", sep = "")
  #saveRDS(diff_genes, file)
  
  #all_degree<- calcDegree(F_panda) + calcDegree(M_panda)
  #find sex divergent here
  #the proportion of sex-biased edges in the male- and female-biased directions is between 0.4 and 0.6
  #sex_div <- diff_genes
  #find female-bias here 
  #the proportion of sex-biased edges in the female direction is greater than 0.6
  
  #find male-bias here
  #male-biased genes (the proportion of sex-biased edges in the male direction is greater than 0.6),
  
  #create a dataframe for each gene if they are sex-divergent, etc. 
  #save 
  
  #calc and save degree out here 
  
  #find sex divergent here
  #find female-bias here 
  #find male-bias here
  
  #create a dataframe for each tf if they are sex-divergent, etc. 
  #save  
  
  
  diff_drug_genes <- diff_genes[names(diff_genes) %in% drug_genes]
  diff_other_genes <- diff_genes[!names(diff_genes) %in% drug_genes]
  
  diff_all_genes<- rbind(data.frame(gene_list =rep( "Drug\nMetabolism", length(diff_drug_genes)), Gene_Degree_Diff= as.numeric(diff_drug_genes)), data.frame(gene_list =rep( "Other", length(diff_other_genes)), Gene_Degree_Diff= as.numeric(diff_other_genes)))
  
  res <- wilcox.test(diff_drug_genes , diff_other_genes  )
  label_tissue <- paste("Wilcoxon signed\nrank test\np-value =\n",  res$p.value, sep = " ")
  title_tissue<- paste("Degree difference of drug metabolismgenes\nbetween", tissue, "sex-specific gene regulatory networks", sep = " ")
  diff_all_genes$gene_list<- factor(diff_all_genes$gene_list, levels= c("Other","Drug\nMetabolism" ))
  
  
  ggplot(diff_all_genes, aes(x=Gene_Degree_Diff, y= gene_list, fill = gene_list)) + geom_violin() +geom_point() +geom_text(y="Drug\nMetabolism", x=-250, label= label_tissue, size= 6) +ggtitle(title_tissue) +xlab("Degree Difference (FEMALE-MALE)") + ylab("Genes")  + scale_fill_viridis( alpha=0.7, option= "H" ,discrete = TRUE)+theme(text = element_text(size = 30,  face="bold"))+ theme(legend.position = "none")
  
  file_name<- paste(path, "sex_degree_difference_plots/", tissue, "_sex_degree_difference_plot.png", sep = "")
  ggsave(file_name, width = 20, height=10, units= "in")
  
  p_value<- res$p.value
  diff<- median(diff_drug_genes)
  #return p_value 
  obj<- list(p_value, diff)
  return(obj)
}
```

```{r}
metadata <- readRDS("~/data/metadata_gtex_filter_samples.rds")
```

```{r}
tissues <- unique(metadata$gtex.smtsd)
#remove cell tissues
tissues<- tissues[! grepl("Cell", tissues)]
```
note processed data had the white sapce removed 
```{r}
tissues_wo_ws <- gsub(" ", "_", tissues, fixed = TRUE)
```


```{r}
test_p<- c()
test_diff <- c()
for (j in 1:length(tissues_wo_ws)){ #length(tissues_wo_ws)
   test <- drug_target_diff_analysis( tissues_wo_ws[j],  path="~/output/alpaca/drug_metabolism_genes/")
  test_p[j]<- test[1]
  test_diff[j]<- test[2]
}
```


```{r}
sig_drug_gene_set <- as.data.frame(cbind(tissues_wo_ws, unlist(test_p), as.numeric(unlist(test_diff))))
colnames(sig_drug_gene_set)<- c("Tissue", "p_value", "degree_diff")
```

```{r}
sig_drug_gene_set$neg_log_p <- -log(as.numeric(sig_drug_gene_set$p_value))
sig_drug_gene_set$degree_diff<- as.numeric(sig_drug_gene_set$degree_diff)
```

```{r}
p_value_cut<- -log(0.05/43)
sig_drug_gene_set$Tissue_2 <- ifelse(sig_drug_gene_set$neg_log_p > p_value_cut,sig_drug_gene_set$Tissue, NA )

ggplot(sig_drug_gene_set, aes(x=degree_diff, y= neg_log_p, label=Tissue_2  ))+ geom_point()+ xlab("Degree Difference (FEMALE-MALE)") + ylab("-log(p-value)") + geom_hline(yintercept=p_value_cut, linetype="dashed", color = "black") + 
    geom_text(size = 5, position = position_stack(vjust = 0.95) )
```

```{r}

sig_drug_gene_set$Tissue<- factor(sig_drug_gene_set$Tissue, levels= sig_drug_gene_set$Tissue[order(sig_drug_gene_set$neg_log_p)])
ggplot(sig_drug_gene_set, aes(y=Tissue, x= neg_log_p, fill=degree_diff ))+ geom_bar(stat="identity",  color= "black") + scale_fill_gradient2(low= "#21908CFF", mid= "white", high= "#440154FF") +theme(text = element_text(size = 20,  face="bold"))+ geom_vline(xintercept=p_value_cut, linetype="dashed", color = "black")+ xlab("-log(p-value)")
ggsave("~/output/alpaca/drug_metabolism_genes/230301_differential_degree_drug_genes_wilcox_test.png", height=12, width=10)
```



```{r}
calc_targeting<- function(tissue, path){
  male_file<- paste0("~/output/alpaca/sex_specific_networks/", tissue, "_M_panda.rds")
  M_panda <- readRDS(male_file)
  female_file<- paste0("~/output/alpaca/sex_specific_networks/", tissue, "_F_panda.rds")
  F_panda <- readRDS(female_file)
  
  f_degree_genes <- calcDegree( F_panda , type="gene", filter = TRUE, trim=TRUE)
  m_degree_genes <- calcDegree( M_panda, type="gene", filter = TRUE, trim=TRUE)
  
  #save degree in here
  
  #panda_in_degree
  file<- paste(path, "panda_in_degree/", tissue, "_female_sex_degree_gene.rds", sep = "")
  saveRDS(f_degree_genes, file)
  file<- paste(path, "panda_in_degree/", tissue, "_male_sex_degree_gene.rds", sep = "")
  saveRDS(m_degree_genes, file)
  all_degree <-  f_degree_genes  + m_degree_genes
  
  f_prop_degree <- f_degree_genes / all_degree
  file<- paste(path, "panda_in_degree/", tissue, "_female_sex_degree_gene_prop.rds", sep = "")
  saveRDS(f_prop_degree, file)
  
  m_prop_degree <- m_degree_genes / all_degree
  file<- paste(path, "panda_in_degree/", tissue, "_male_sex_degree_gene_prop.rds", sep = "")
  saveRDS(m_prop_degree, file)
  
  #find sex divergent here
  #the proportion of sex-biased edges in the male- and female-biased directions is between 0.4 and 0.6
  sex_div <- names(f_prop_degree)[ f_prop_degree > 0.4 &  f_prop_degree< 0.6]
  
  #find female-bias here 
  f_bias<- names(f_prop_degree)[ f_prop_degree >0.6]
  #the proportion of sex-biased edges in the female direction is greater than 0.6
  
  #find male-bias here
  #male-biased genes (the proportion of sex-biased edges in the male direction is greater than 0.6),
  m_bias<- names(m_prop_degree)[ m_prop_degree >0.6]
  #create list 
  list_bias<- list(sex_div, f_bias, m_bias)
  
  #save 
  file<- paste(path, "panda_in_degree/", tissue, "_sex_bias_gene_list.rds", sep = "")
  saveRDS(list_bias, file)
  
  
  #out- degree
  f_degree_tf <- calcDegree( F_panda , type="tf", filter = TRUE, trim=TRUE)
  m_degree_tf <- calcDegree( M_panda, type="tf", filter = TRUE, trim=TRUE)
  
  #save degree in here
  file<- paste(path, "panda_out_degree/", tissue, "_female_sex_degree_tf.rds", sep = "")
  saveRDS(f_degree_tf, file)
  file<- paste(path, "panda_out_degree/", tissue, "_male_sex_degree_tf.rds", sep = "")
  saveRDS(m_degree_tf, file)
  all_degree <-  f_degree_tf  + m_degree_tf
  
  f_prop_degree <- f_degree_tf / all_degree
  file<- paste(path, "panda_out_degree/", tissue, "_female_sex_degree_tf_prop.rds", sep = "")
  saveRDS(f_prop_degree, file)
  
  m_prop_degree <- m_degree_tf / all_degree
  file<- paste(path, "panda_out_degree/", tissue, "_male_sex_degree_tf_prop.rds", sep = "")
  saveRDS(m_prop_degree, file)
  
  #find sex divergent here
  #the proportion of sex-biased edges in the male- and female-biased directions is between 0.4 and 0.6
  sex_div <- names(f_prop_degree)[ f_prop_degree > 0.4 &  f_prop_degree< 0.6]
  
  #find female-bias here 
  f_bias<- names(f_prop_degree)[ f_prop_degree >0.6]
  #the proportion of sex-biased edges in the female direction is greater than 0.6
  
  #find male-bias here
  #male-biased tf (the proportion of sex-biased edges in the male direction is greater than 0.6),
  m_bias<- names(m_prop_degree)[ m_prop_degree >0.6]
  #create list 
  list_bias<- list(sex_div, f_bias, m_bias)
  
  #save 
  file<- paste(path, "panda_out_degree/", tissue, "_sex_bias_tf_list.rds", sep = "")
  saveRDS(list_bias, file)
  
  
}  
```

```{r}
#calc_targeting("Liver", path="~/output/alpaca/")
for (i in 1:length(tissues_wo_ws)){ #length(tissues_wo_ws)
  calc_targeting( tissues_wo_ws[i],  path="~/output/alpaca/")
}
```



list of genes and tfs
 
```{r}
Liver_tf_gene_sex_drug_only <- Liver__male_female_long[Liver__male_female_long$gene %in% drug_genes,]
```
```{r}
Liver_tf_gene_sex_drug_only<- Liver_tf_gene_sex_drug_only[ Liver_tf_gene_sex_drug_only$male ==1 | Liver_tf_gene_sex_drug_only$female == 1,]
```

```{r}
all_male_tfs<- unique(Liver_tf_gene_sex_drug_only$TF[Liver_tf_gene_sex_drug_only$male == 1])
all_female_tfs<- unique(Liver_tf_gene_sex_drug_only$TF[Liver_tf_gene_sex_drug_only$female == 1])
```

```{r}
setdiff(all_male_tfs, all_female_tfs)
```

```{r}
setdiff(all_female_tfs, all_male_tfs)
```
only one transcription factor is unique to male the rest are shared. 

```{r}
Liver_sex_bias_tf_list <- readRDS("~/output/alpaca/panda_out_degree/Liver_sex_bias_tf_list.rds")
```

```{r}
all_tfs<- unique(all_female_tfs, all_male_tfs)
sex_div_tf<- Liver_sex_bias_tf_list[[1]][Liver_sex_bias_tf_list[[1]] %in% all_tfs]
length(sex_div_tf)
f_bias_tf<- Liver_sex_bias_tf_list[[2]][Liver_sex_bias_tf_list[[2]] %in% all_tfs]
length(f_bias_tf)
m_bias_tf<- Liver_sex_bias_tf_list[[3]][Liver_sex_bias_tf_list[[3]] %in% all_tfs]
length(m_bias_tf)
```



```{r}
Liver_tf_gene_sex_drug_only[Liver_tf_gene_sex_drug_only$TF == "ETS1",]
```
This gene encodes a member of the aldehyde dehydrogenase protein family. Aldehyde dehydrogenases are a family of isozymes that may play a major role in the detoxification of aldehydes generated by alcohol metabolism and lipid peroxidation. The encoded protein is able to oxidize long-chain fatty aldehydes in vitro, and may play a role in protection from oxidative stress.

Liver_tf_gene_sex_drug_only
```{r}
Liver_tf_gene_sex_drug_only$edge_diff <- (Liver_tf_gene_sex_drug_only$female- Liver_tf_gene_sex_drug_only$male)
```

```{r}
#Liver_tf_gene_sex_drug_only$edge_sex <- ifelse(Liver_tf_gene_sex_drug_only$edge_diff == 1, "female", ifelse(Liver_tf_gene_sex_drug_only$edge_diff == -1, "male", "both"))
```

```{r}
liver_drug_edges <- pivot_wider(data= as.data.frame( Liver_tf_gene_sex_drug_only[,-c(3,4,6)] ), names_from = gene, values_from=edge_diff, values_fill= 1e-10)
```

```{r}
liver_drug_edges<- as.data.frame(liver_drug_edges)
rownames(liver_drug_edges)<- liver_drug_edges$TF
```

```{r}
liver_drug_edges<- liver_drug_edges[,-1]
```
```{r}

#colors2 <- structure(1:4, names = c("-1", "0", "1", "2")) # black, red, green, blue
colors<- 1:4
names(colors)<- c("1e-10", "-1", "0", "1")
colors[1]<- "white"
colors[2]<- "#21908CFF" #"#440154FF", "#21908CFF"
colors[3]<- "lightgray"
colors[4]<- "#440154FF"

png("~/output/alpaca/drug_metabolism_genes/liver_drug_metabolism_edge_heatmap.png",width=15,height=10,units="in",res=1400)
Heatmap(liver_drug_edges, name = "Edge Present", col = colors, show_row_names = FALSE,
    column_title = "Male and female edges in liver networks",heatmap_legend_param = list(at = c("1e-10", "-1", "0", "1"),labels= c("no edge", "male", "both", "female"), column_names_gp =gpar(fontsize = 18 , fontface = "bold"), labels_gp = gpar(fontsize = 12, fontface = "bold") ))
dev.off()
```


```{r}
tf_count_table<- matrix(0, nrow= nrow(liver_drug_edges), ncol=4 )
for (i in 1:nrow(liver_drug_edges)){
  tf_count_sub <- table(unlist(liver_drug_edges[i,]))
  try(tf_count_table[i,1]<- tf_count_sub[names(tf_count_sub) == -1])
  try(tf_count_table[i,2]<- tf_count_sub[names(tf_count_sub) == 0])
  try(tf_count_table[i,3]<- tf_count_sub[names(tf_count_sub) == 1e-10 ])
  try(tf_count_table[i,4]<- tf_count_sub[names(tf_count_sub) == 1 ])
}
rownames(tf_count_table)<- rownames(liver_drug_edges)
```

```{r}
hist(tf_count_table[,4]- tf_count_table[,1])
```

```{r}
print("male_tf_subset_drug_genes")
rownames(tf_count_table)[(tf_count_table[,4]- tf_count_table[,1]) < -2]
male_tf <- rownames(tf_count_table)[(tf_count_table[,4]- tf_count_table[,1]) < -2]
print("female_tf_subset_drug_genes")
rownames(tf_count_table)[(tf_count_table[,4]- tf_count_table[,1]) > 4]
female_tf <- rownames(tf_count_table)[(tf_count_table[,4]- tf_count_table[,1]) > 4]
```

```{r}
tf_sub  <- c(female_tf, male_tf )
tf_location <- (1:nrow(liver_drug_edges))[rownames(liver_drug_edges) %in% tf_sub]
Tf_anno<- anno_mark(at = tf_location, labels= rownames(liver_drug_edges)[tf_location], which = "row")
```


```{r}
png("~/output/alpaca/drug_metabolism_genes/liver_drug_metabolism_edge_heatmap_v2.png",width=15,height=10,units="in",res=1400)
Heatmap(liver_drug_edges, name = "Edge Present", col = colors, show_row_names = FALSE,
    column_title = "Male and female edges in liver networks",heatmap_legend_param = list(at = c("1e-10", "-1", "0", "1"),labels= c("no edge", "male", "both", "female"), column_names_gp =gpar(fontsize = 18 , fontface = "bold"), labels_gp = gpar(fontsize = 12, fontface = "bold") )) + rowAnnotation(mark = Tf_anno)
dev.off()
```



```{r}
Liver_gtex_qsmooth_expression <- readRDS("~/output/lioness/processed_normalized_expression/Liver_gtex_processed_expression.rds")
Liver_gtex_metadata <- readRDS("~/data/gtex_qsmooth/Liver_gtex_metadata.rds")
```

```{r}
identical(colnames(Liver_gtex_qsmooth_expression), Liver_gtex_metadata$external_id)
```


```{r}
Liver_gtex_qsmooth_expression<- as.data.frame(Liver_gtex_qsmooth_expression)
Liver_gtex_qsmooth_expression$genes <- rownames(Liver_gtex_qsmooth_expression)
Liver_gtex_qsmooth_expression_long <- pivot_longer(as.data.frame(Liver_gtex_qsmooth_expression), col=!genes, names_to = "sample", values_to = "expression")
```


```{r}
male_samples<- Liver_gtex_metadata$external_id[Liver_gtex_metadata$gtex.sex ==  "M"]
Liver_gtex_qsmooth_expression_long$sex <- Liver_gtex_qsmooth_expression_long$sample %in% male_samples
Liver_gtex_qsmooth_expression_long$sex <- ifelse(Liver_gtex_qsmooth_expression_long$sex, "male", "female")
```

```{r}
table(Liver_gtex_qsmooth_expression_long$sex)
```


stat5B

```{r}
all_cor<- c()
all_p<- c()
f_cor<- c()
f_p<- c()
m_cor <- c()
m_p<- c()
for (i in 1:nrow(Liver_tf_gene_sex_drug_only)){ 
  tf_name<- Liver_tf_gene_sex_drug_only[i,1]
  gene_name<- Liver_tf_gene_sex_drug_only[i,2]
  #get tf expression
  tf <- Liver_gtex_qsmooth_expression_long$expression[Liver_gtex_qsmooth_expression_long$genes == tf_name]
  gene<-  Liver_gtex_qsmooth_expression_long$expression[Liver_gtex_qsmooth_expression_long$genes == gene_name]
  res<- cor.test(tf, gene, method= "pearson",exact=FALSE)
  all_cor[i]<- res$estimate
  all_p[i]<- res$p.value
  
  tf <- Liver_gtex_qsmooth_expression_long$expression[Liver_gtex_qsmooth_expression_long$genes == tf_name & Liver_gtex_qsmooth_expression_long$sex == "female"]
  gene<-  Liver_gtex_qsmooth_expression_long$expression[Liver_gtex_qsmooth_expression_long$genes == gene_name & Liver_gtex_qsmooth_expression_long$sex == "female"]
  res<- cor.test(tf, gene, method= "pearson",exact=FALSE)
  f_cor[i]<- res$estimate
  f_p[i]<- res$p.value
  
   tf <- Liver_gtex_qsmooth_expression_long$expression[Liver_gtex_qsmooth_expression_long$genes == tf_name & Liver_gtex_qsmooth_expression_long$sex == "male"]
  gene<-  Liver_gtex_qsmooth_expression_long$expression[Liver_gtex_qsmooth_expression_long$genes == gene_name & Liver_gtex_qsmooth_expression_long$sex == "male"]
  res<- cor.test(tf, gene, method= "pearson",exact=FALSE)
  m_cor[i]<- res$estimate
  m_p[i]<- res$p.value
}
Liver_tf_gene_sex_drug_only<- cbind(Liver_tf_gene_sex_drug_only, all_cor,all_p, m_cor, m_p, f_cor, f_p)
```

```{r}
Liver_tf_gene_sex_drug_only$all_rel <- ifelse(Liver_tf_gene_sex_drug_only$all_cor >0, "pos", "neg")
Liver_tf_gene_sex_drug_only$f_rel <- ifelse(Liver_tf_gene_sex_drug_only$f_cor >0, "pos", "neg")
Liver_tf_gene_sex_drug_only$m_rel <- ifelse(Liver_tf_gene_sex_drug_only$m_cor >0, "pos", "neg")
```

pvalue correction 

```{r}
Liver_tf_gene_sex_drug_only$all_p_adj <- p.adjust(Liver_tf_gene_sex_drug_only$all_p, method= "BH")
Liver_tf_gene_sex_drug_only$f_p_adj <- p.adjust(Liver_tf_gene_sex_drug_only$f_p, method= "BH")
Liver_tf_gene_sex_drug_only$m_p_adj <- p.adjust(Liver_tf_gene_sex_drug_only$m_p, method= "BH")
```

```{r}
Liver_tf_gene_sex_drug_only$all_p_adj_tf <- ifelse( Liver_tf_gene_sex_drug_only$all_p_adj < 0.05, "yes", "no")
Liver_tf_gene_sex_drug_only$f_p_adj_tf <- ifelse( Liver_tf_gene_sex_drug_only$f_p_adj < 0.05, "yes", "no")
Liver_tf_gene_sex_drug_only$m_p_adj_tf <- ifelse( Liver_tf_gene_sex_drug_only$m_p_adj < 0.05, "yes", "no")

```

```{r}
Liver_tf_gene_sex_drug_only$summary <- paste(Liver_tf_gene_sex_drug_only$f_rel, Liver_tf_gene_sex_drug_only$f_p_adj_tf, Liver_tf_gene_sex_drug_only$m_rel, Liver_tf_gene_sex_drug_only$m_p_adj_tf, sep = "_")
```

```{r}
saveRDS(Liver_tf_gene_sex_drug_only, "~/output/alpaca/drug_metabolism_genes/liver_drug_metabolism_gene_edges.rds")
```


```{r}
Liver_tf_gene_sex_drug_both <- Liver_tf_gene_sex_drug_only[Liver_tf_gene_sex_drug_only$edge_diff == 0,]

df_edge_cor_counts<- as.data.frame( table(Liver_tf_gene_sex_drug_both$summary ))
```

```{r}
df_edge_cor_counts
```



```{r}
Liver_tf_gene_sex_drug_only$edge <- paste(Liver_tf_gene_sex_drug_only$TF, Liver_tf_gene_sex_drug_only$gene, sep= "_")
```



tfs activating in females
```{r}
f_act_edge<- unique(Liver_tf_gene_sex_drug_only$edge[Liver_tf_gene_sex_drug_only$f_cor > 0 & Liver_tf_gene_sex_drug_only$f_p_adj < 0.05 & Liver_tf_gene_sex_drug_only$female== 1 ])
```


tfs repressing in females
```{r}
f_repress_edge<-unique(Liver_tf_gene_sex_drug_only$edge[Liver_tf_gene_sex_drug_only$f_cor < 0 & Liver_tf_gene_sex_drug_only$f_p_adj < 0.05 & Liver_tf_gene_sex_drug_only$female== 1])
```

tfs activating in males
```{r}
m_act_edge<-unique(Liver_tf_gene_sex_drug_only$edge[Liver_tf_gene_sex_drug_only$m_cor > 0 & Liver_tf_gene_sex_drug_only$m_p_adj < 0.05  & Liver_tf_gene_sex_drug_only$male== 1])
```

```{r}
m_repress_edge<-unique(Liver_tf_gene_sex_drug_only$edge[Liver_tf_gene_sex_drug_only$m_cor < 0 & Liver_tf_gene_sex_drug_only$m_p_adj < 0.05  & Liver_tf_gene_sex_drug_only$male== 1])
```

m3 = make_comb_mat(lt, mode = "union")

```{r}
comb_mat<- make_comb_mat(list("Female Activator Edges"=f_act_edge, "Female Repressor Edges"=f_repress_edge, "Male Activator Edges"=m_act_edge, "Male Repressor Edges"=m_repress_edge), mode = "distinct")
```

```{r}
cs <-  comb_size(comb_mat)
plot<- UpSet(comb_mat, comb_order = order(-comb_size(comb_mat)), top_annotation = HeatmapAnnotation(
        "Intersection size" = anno_barplot(cs, 
            ylim = c(0, max(cs)*1.1),
            border = FALSE, 
            gp = gpar(fill = "black"), 
            height = unit(4, "cm")
        ), 
        annotation_name_side = "left", 
        annotation_name_rot = 90))
plot_draw <- draw(plot)
od <- column_order(plot_draw)
decorate_annotation("Intersection size", {
    grid.text(cs[od], x = seq_along(cs), y = unit(cs[od], "native") + unit(2, "pt"), 
        default.units = "native", just = c("left", "bottom"), 
        gp = gpar(fontsize = 11, face="bold",col = "#404040"), rot = 45)
})
```


pathway analysis on the different edges

```{r}
only_male_act_edges<- setdiff(m_act_edge, c(m_repress_edge, f_repress_edge, f_act_edge ))
```

```{r}
only_male_act_tf_genes <- unique(unlist(str_split(only_male_act_edges, "_")))
```


```{r}
set.seed(101)
  pathway_results_male_act <- gost(query = only_male_act_tf_genes , 
                               organism = "hsapiens", ordered_query = FALSE, 
                               multi_query = FALSE, significant = TRUE, exclude_iea= FALSE, measure_underrepresentation = FALSE, evcodes = FALSE,
                               user_threshold = 0.05, correction_method = "g_SCS", 
                               domain_scope = "annotated", custom_bg = NULL, 
                               numeric_ns = "", as_short_link = FALSE)
   pathway_results_male_res_act <-  pathway_results_male_act$result
```

```{r}
only_male_repress_edges<- setdiff(m_repress_edge, c(f_repress_edge, f_act_edge ,m_act_edge))
```

```{r}
only_male_repress_tf_genes <- unique(unlist(str_split(only_male_repress_edges, "_")))
```


```{r}
set.seed(101)
  pathway_results_male_repress <- gost(query = only_male_repress_tf_genes , 
                               organism = "hsapiens", ordered_query = FALSE, 
                               multi_query = FALSE, significant = TRUE, exclude_iea= FALSE, measure_underrepresentation = FALSE, evcodes = FALSE,
                               user_threshold = 0.05, correction_method = "g_SCS", 
                               domain_scope = "annotated", custom_bg = NULL, 
                               numeric_ns = "", as_short_link = FALSE)
   pathway_results_male_res_repress <-  pathway_results_male_repress$result
```


```{r}
only_female_act_edges<- setdiff(f_act_edge, c(f_repress_edge, m_repress_edge, m_act_edge ))
```

```{r}
only_female_act_tf_genes <- unique(unlist(str_split(only_female_act_edges, "_")))
```


```{r}
set.seed(101)
  pathway_results_female_act <- gost(query = only_female_act_tf_genes , 
                               organism = "hsapiens", ordered_query = FALSE, 
                               multi_query = FALSE, significant = TRUE, exclude_iea= FALSE, measure_underrepresentation = FALSE, evcodes = FALSE,
                               user_threshold = 0.05, correction_method = "g_SCS", 
                               domain_scope = "annotated", custom_bg = NULL, 
                               numeric_ns = "", as_short_link = FALSE)
   pathway_results_female_res_act <-  pathway_results_female_act$result
```

```{r}
only_female_repress_edges<- setdiff(f_repress_edge, c(m_repress_edge, m_act_edge ,f_act_edge))
```

```{r}
only_female_repress_tf_genes <- unique(unlist(str_split(only_female_repress_edges, "_")))
```


```{r}
set.seed(101)
  pathway_results_female_repress <- gost(query = only_female_repress_tf_genes , 
                               organism = "hsapiens", ordered_query = FALSE, 
                               multi_query = FALSE, significant = TRUE, exclude_iea= FALSE, measure_underrepresentation = FALSE, evcodes = FALSE,
                               user_threshold = 0.05, correction_method = "g_SCS", 
                               domain_scope = "annotated", custom_bg = NULL, 
                               numeric_ns = "", as_short_link = FALSE)
   pathway_results_female_res_repress <-  pathway_results_female_repress$result
```




```{r}
go_term_heatmap<- function(female_act_pathways, female_repress_pathways, male_act_pathways, male_repress_pathways, threshold = 0.95, file_name){
  #input
  #limma_pathways, deseqq2_pathways, TFL_pathways- the gprofiler result data frame for each method with the last column (named set)
  #indicating if the pathway was from the up or down group
  #list_type- up or down regulated 
  #threshold- is the threshold of how far up or down the go ontology tree to go. default to 0.95
  #file name for the parent go term results
  
  #output 
  #heatmap
  
  #get terms
  female_act_bp<- female_act_pathways$term_id[ female_act_pathways$source == "GO:BP" ]
  female_repress_bp <- female_repress_pathways$term_id[ female_repress_pathways$source == "GO:BP"]
  male_act_bp<- male_act_pathways$term_id[ male_act_pathways$source == "GO:BP" ]
  male_repress_bp <- male_repress_pathways$term_id[ male_repress_pathways$source == "GO:BP"]
  
  #run the go term semantic similarity 
  go1 <-  unique(c(female_act_bp, female_repress_bp, male_act_bp, male_repress_bp ))
  go_sim <- mgoSim(go1, go1, semData=hsGO, measure="Wang", combine=NULL)
  
  #get the parent terms from rrvgo for the pathways
  res <- reduceSimMatrix(go_sim, threshold = threshold)
  res_v2<- res[match(colnames(go_sim), res$go),]
  
  
  
  #determine which pathway is enriched in the different methods for the heatmap annotation
  female_act_list <- grepl(paste(female_act_bp,collapse="|"), colnames(go_sim)) 
  female_repress_list <- grepl(paste(female_repress_bp,collapse="|"), colnames(go_sim)) 
  male_act_list <- grepl(paste(male_act_bp,collapse="|"), colnames(go_sim)) 
  male_repress_list <- grepl(paste(male_repress_bp,collapse="|"), colnames(go_sim)) 
  
  
  #handing the case where there are no pathways enriched
  if(length(female_act_list) ==0){ female_act_list <- rep(FALSE,ncol(go_sim) )} 
  if(length(female_repress_list) ==0){ female_repress_list <- rep(FALSE,ncol(go_sim) )} 
  if(length( male_act_list) ==0){  male_act_list <- rep(FALSE,ncol(go_sim) )} 
  if(length(male_repress_list) ==0){ male_repress_list <- rep(FALSE,ncol(go_sim) )} 

  
  #pick the number of colors note limit is about 9 
  bp_color<- brewer.pal(n = length(unique(res_v2$parentTerm)), name = "Paired")
  names(bp_color)<- unique(res_v2$parentTerm)
  
  #create heatmap
  #"Female Repressor Edges"=f_repress_edge, "Male Activator Edges"=m_act_edge, "Male Repressor Edges"=m_repress_edge)
  row_ha = HeatmapAnnotation("Female Activator Edges"=female_act_list, "Female Repressor Edges"= female_repress_list, "Male Activator Edges"=  male_act_list, "Male Repressor Edges" = male_repress_list, "Common Parent GO Term"= res_v2$parentTerm , col = list("Female Activator Edges"= c("TRUE" = "black", "FALSE" = "white"),"Female Repressor Edges" = c("TRUE" = "black", "FALSE" = "white"),"Male Activator Edges" = c("TRUE" = "black", "FALSE" = "white"),"Male Repressor Edges" = c("TRUE" = "black", "FALSE" = "white"),
                                                                                                                                              "Common Parent GO Term"= bp_color ), annotation_name_gp= gpar(fontsize = 16,  fontface = "bold"), 
                             annotation_legend_param = list("Female Repressor Edges"= list(title_gp = gpar(fontsize = 15, fontface = "bold"), labels_gp = gpar(fontsize = 13, fontface = "bold")), 
                                                            "Female Activator Edges" = list(title_gp = gpar(fontsize = 15, fontface = "bold"), labels_gp = gpar(fontsize = 13, fontface = "bold")), 
                                                            "Male Activator Edges"= list(title_gp = gpar(fontsize = 15, fontface = "bold"), labels_gp = gpar(fontsize = 13, fontface = "bold")),"Male Repressor Edges"= list(title_gp = gpar(fontsize = 15, fontface = "bold"), labels_gp = gpar(fontsize = 13, fontface = "bold")),
                                                            "Common Parent GO Term" = list(title_gp = gpar(fontsize = 15, fontface = "bold"), labels_gp = gpar(fontsize = 13, fontface = "bold"))))
  col_fun = colorRamp2(c(0,  1), c( "black", "yellow"))
  
  #SAVE THE PARENT MATCHES
  res_v3<- cbind(res_v2,female_act_list, female_repress_list, male_act_list, male_repress_list )
  write.csv(res_v3, file_name)
  heatmap_v1 <- Heatmap(go_sim, nam= "GO Term Similarity (Wang)", col = col_fun, show_column_names = FALSE,  show_row_names = FALSE, top_annotation = row_ha,  
          clustering_distance_rows= "euclidean",
          clustering_distance_columns=  "euclidean",
          clustering_method_rows = "ward.D2" ,
          clustering_method_columns="ward.D2", heatmap_legend_param = list( title_gp = gpar(fontsize = 15 , fontface = "bold"), labels_gp = gpar(fontsize = 12, fontface = "bold")))
  #draw(heatmap_v1, annotation_legend_side = "bottom")
  #heatmap
  Heatmap(go_sim, nam= "GO Term Similarity (Wang)", col = col_fun, show_column_names = FALSE,  show_row_names = FALSE, top_annotation = row_ha,  
          clustering_distance_rows= "euclidean",
          clustering_distance_columns=  "euclidean",
          clustering_method_rows = "ward.D2" ,
          clustering_method_columns="ward.D2", heatmap_legend_param = list( title_gp = gpar(fontsize = 15 , fontface = "bold"), labels_gp = gpar(fontsize = 12, fontface = "bold")))
  
  column_dend = hclust(dist(t(go_sim)), method = "ward.D2")
  
  heatmap_v2 <- Heatmap(matrix(nrow = 0, ncol = ncol(go_sim)),
          cluster_columns = column_dend, 
          show_column_names = FALSE,  
          show_row_names = FALSE, 
          top_annotation = row_ha) 
  draw(heatmap_v2, annotation_legend_side = "bottom")
  
}
```
```{r}
#functions from rrvgo
#rrvgo github (getGoTerm, loadOrgdb, getGoSize, reduceSimMatrix)
getGoTerm <- function(x) {
  sapply(x, function(x) tryCatch(GO.db::GOTERM[[x]]@Term, error=function(e) NA))
}
loadOrgdb <- function(orgdb) {
  if(!requireNamespace(orgdb, quietly = TRUE)) {
    stop("Bioconductor orgdb for ", orgdb, " not found. Consider installing it.",
         call. = FALSE)
  }
  eval(parse(text=paste0(orgdb, "::", orgdb)))
}
getGoSize <- function(terms, orgdb, keytype) {
  if(all(is(orgdb) != "OrgDb")) {
    orgdb <- loadOrgdb(orgdb)
  }
  
  # get all GO terms with genes associated
  go <- suppressMessages(
    AnnotationDbi::select(orgdb,
                          keytype=keytype,
                          columns=c("GO", "ONTOLOGY"),
                          keys=AnnotationDbi::keys(orgdb, keytype=keytype)))
  go <- go[!is.na(go$GO), ]
  go <- go[go$GO %in% terms, ]
  
  # count
  counts   <- table(go$GO)
  go <- go[go$GO %in% terms, ]
  empty    <- terms[!(terms %in% names(counts))]
  nocounts <- setNames(rep(0, length(empty)), empty)
  
  c(counts, nocounts)
}
reduceSimMatrix <- function (simMatrix, scores = NULL, threshold = 0.7, orgdb="org.Hs.eg.db", keytype = "ENTREZID") {
  if (!is.null(scores) && !all(rownames(simMatrix) %in% names(scores))) {
    stop("Scores vector does not contain all terms in the similarity matrix")
  }
  sizes <- getGoSize(rownames(simMatrix), orgdb, keytype)
  if (is.null(scores)) {
    message("No scores provided. Falling back to term's size")
    scores <- sizes
  }
  scores <- scores[match(rownames(simMatrix), names(scores))]
  orows <- match(rownames(simMatrix), names(scores))
  ocols <- match(colnames(simMatrix), names(scores))
  simMatrix <- simMatrix[orows, ocols]
  o <- rev(order(scores, sizes, na.last = FALSE))
  simMatrix <- simMatrix[o, o]
  cluster <- cutree(hclust(as.dist(1 - simMatrix)), h = threshold)
  clusterRep <- tapply(rownames(simMatrix), cluster, function(x) x[which.max(scores[x])])
  data.frame(go = rownames(simMatrix), cluster = cluster, parent = clusterRep[cluster], 
             parentSimScore = unlist(Map(seq_len(nrow(simMatrix)), 
                                         clusterRep[cluster], f = function(i, j) simMatrix[i, 
                                                                                           j])), score = scores[match(rownames(simMatrix), 
                                                                                                                      names(scores))], size = sizes[match(rownames(simMatrix), 
                                                                                                                                                          names(sizes))], term =getGoTerm(rownames(simMatrix)), 
             parentTerm = getGoTerm(clusterRep[cluster]))
}

```

```{r}
library(GOSemSim)
hsGO <- godata('org.Hs.eg.db', ont="BP")
```

```{r}
go_term_heatmap(pathway_results_female_res_act, pathway_results_female_res_repress, pathway_results_male_res_act , pathway_results_male_res_repress, threshold = 0.94, "~/output/alpaca/drug_metabolism_genes/liver_edge_differences_pathways.csv")
```


```{r}
list("Female Activator Edges"=f_act_edge, "Female Repressor Edges"=f_repress_edge, "Male Activator Edges"=m_act_edge, "Male Repressor Edges"=m_repress_edge)
```

```{r}
f_act_edge_gene_count <- as.data.frame(table(str_split(f_act_edge, "_", simplify = TRUE)[,2]))
f_repress_edge_gene_count <- as.data.frame(table(str_split(f_repress_edge, "_", simplify = TRUE)[,2]))
m_act_edge_gene_count <- as.data.frame(table(str_split(m_act_edge, "_", simplify = TRUE)[,2]))
m_repress_edge_gene_count <- as.data.frame(table(str_split(m_repress_edge, "_", simplify = TRUE)[,2]))
```

```{r}
count_act_repress <- merge(f_act_edge_gene_count, f_repress_edge_gene_count, by= "Var1", all =TRUE)
count_act_repress <- merge(count_act_repress, m_act_edge_gene_count, by= "Var1", all =TRUE)
count_act_repress <- merge(count_act_repress, m_repress_edge_gene_count, by= "Var1", all =TRUE)
```

```{r}
rownames(count_act_repress) <- count_act_repress[,1]
```

```{r}
count_act_repress<- count_act_repress[,-1]
```

```{r}
colnames(count_act_repress)<- c("Female_Activator_Edges", "Female_Repressor_Edges", "Male_Activator_Edges", "Male_Repressor_Edges")
```

```{r}
count_act_repress$Female_Activator_Edges<- ifelse( is.na(count_act_repress$Female_Activator_Edges), 0, count_act_repress$Female_Activator_Edges)
count_act_repress$Female_Repressor_Edges<- ifelse( is.na(count_act_repress$Female_Repressor_Edges), 0, count_act_repress$Female_Repressor_Edges)
count_act_repress$Male_Activator_Edges<- ifelse( is.na(count_act_repress$Male_Activator_Edges), 0, count_act_repress$Male_Activator_Edges)
count_act_repress$Male_Repressor_Edges<- ifelse( is.na(count_act_repress$Male_Repressor_Edges), 0, count_act_repress$Male_Repressor_Edges)
```


```{r}
col_fun = colorRamp2(c(0,  45), c( "black", "yellow"))
Heatmap(t(count_act_repress), nam= "Number of Edges", col = col_fun, show_column_names = TRUE,  show_row_names = TRUE,
          clustering_distance_rows= "euclidean",
          clustering_distance_columns=  "euclidean",
          clustering_method_rows = "ward.D2" ,
          clustering_method_columns="ward.D2", heatmap_legend_param = list( title_gp = gpar(fontsize = 15 , fontface = "bold"), labels_gp = gpar(fontsize = 12, fontface = "bold")))
```

```{r}
female_diff<-  count_act_repress$Female_Activator_Edges- count_act_repress$Female_Repressor_Edges
male_diff<-  count_act_repress$Male_Activator_Edges- count_act_repress$Male_Repressor_Edges
```

```{r}
diff_matrix<- cbind(female_diff, male_diff)
```

```{r}
rownames(diff_matrix)<- rownames(count_act_repress)
colnames(diff_matrix)<- c("Female_Edge_Differences", "Male_Edge_Differences")
```

```{r}
diff_matrix[,1]<- as.numeric(diff_matrix[,1])
diff_matrix[,2]<- as.numeric(diff_matrix[,2])
```


```{r}
#col_fun <- colorRamp2(c(-30, 0,  30), c( "blue", "white", "yellow"))
Heatmap(t(diff_matrix), nam= "Activator - Repressor\nEdges",col=colorRamp2(c(-26, 0,  26), c( "blue", "black", "yellow")), show_column_names = TRUE,  show_row_names = TRUE,
          clustering_distance_rows= "euclidean",
          clustering_distance_columns=  "euclidean",
          clustering_method_rows = "ward.D2" ,
          clustering_method_columns="ward.D2", heatmap_legend_param = list( title_gp = gpar(fontsize = 15 , fontface = "bold", at = c(-26,0,26)), labels_gp = gpar(fontsize = 12, fontface = "bold")))
```


