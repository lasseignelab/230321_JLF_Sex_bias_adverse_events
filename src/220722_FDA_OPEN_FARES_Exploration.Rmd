---
title: "220722_FDA_OPEN_FARES_Exploration"
author: "Jennifer Fisher"
date: '2022-07-22'
output:
  html_document:
    toc: true
    theme: united
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# START 
    Goal/Purpose of operations: 
    THE FARES adverse event data was download from FDA open July 2021. this data was data wrangled to create R dataframe with the case number, sex (if the case didn't have a sex it was removed), age (if age was not reported the age is NA), number of drugs that the person was on and drug and possible side effect. It is important to note that the FARES database does not require causal relationship for side effect to reported any anyone can report a case. 
    The goal of this script is to combine the data frame investigate the data by plot the different metrics. Also, I want to calculate the reporting odds ratio. 
    
    Started psedocode on: 
    220722
    
    System which operations were done on: 
    my laptop with a docker
    
    GitHub Repo:
    Sex_Bias_Adverse_Events
    
    Docker:
    jenfisher7/rstudio_sex_bias_analysis
    
    Directory of operations: 
    /Users/jenniferfisher/Documents/Sex_Bias_Adverse_Events:/home/rstudio/
    
    Scripts being edited for operations: 
    NA
    
    Data being used:description and location
    FARES/FDA_open: description in the goal statement. data/FDA_OPEN
    
    Papers and tools:
    FARES
    report odds ratio
    AE_mapping

# STEPS
### Set working directory 
```{r}
setwd("/home/rstudio")
```

```{r}
source("./sex_bias_functions.R")
library(ggplot2)
library(viridis)
```


### load in data
```{r}
files <- list.files(path= "~/data/FDA_OPEN/" , pattern = ".rds")
head(files)
files <- paste0("~/data/FDA_OPEN/", files)
head(files)
```

combine the data frames together
```{r}
FARES <- readRDS(files[1])
for (i in 2:length(files)){
  dat <- readRDS(files[i])
  FARES<- rbind(FARES, dat)
}
dim(FARES)
FARES[1:5,]
```
in the future save this file and watch out for duplicate cases

create the meddra term mapping 
```{r}
#lowest_level_term
llt_meddra<- read.delim("~/data/MedDRA_25_0_English/MedAscii/llt.asc", sep="$", header= FALSE)
# preferred terms
pt_meddra <- read.delim("~/data/MedDRA_25_0_English/MedAscii/pt.asc", sep="$", header= FALSE)
#high level term
hlt_meddra<- read.delim("~/data/MedDRA_25_0_English/MedAscii/hlt.asc", sep="$", header= FALSE)
#high level group 
hlgt_meddra<- read.delim("~/data/MedDRA_25_0_English/MedAscii/hlgt.asc", sep="$", header= FALSE)
#system organ
soc_meddra <- read.delim("~/data/MedDRA_25_0_English/MedAscii/soc.asc", sep="$", header= FALSE)
```

create a mapping
1- llt, 2-pt, 3-hlt, 4-hglt, 5-soc, repat with the names
```{r}
meddra_mapping <- llt_meddra[,1:3]
#add the pt and soc info 
info_add<- c("pt_id", "pt_name", "soc_id")
for (i in 1:nrow(meddra_mapping)){
  info_1 <- pt_meddra[meddra_mapping[i,3] == pt_meddra[,1],c(1,2,4)]
  info_add<- rbind(info_add, info_1)
}
```

```{r}
info_add<- info_add[-1,]
rownames(meddra_mapping)<- NULL
rownames(info_add)<- NULL
meddra_mapping_v2 <- cbind(meddra_mapping, info_add)
```
add the soc names
```{r}
soc_list <- c("soc_name", "soc_short")
for(i in 1:nrow(meddra_mapping_v2)){
  soc_list_v2 <- soc_meddra[meddra_mapping_v2[i,6]== soc_meddra[,1], c(2,3)]
  soc_list<- rbind(soc_list, soc_list_v2)
}
soc_list<- soc_list[-1,]
```

```{r}
meddrda_mapping_all <- cbind(meddra_mapping_v2, soc_list)
meddrda_mapping_all[1:5,]
```
```{r}
colnames(meddrda_mapping_all)<- c("llt_id", "llt_name", "pt_id", "pt_id2", "pt_name", "soc_id", "soc_name", "soc_short")
```

```{r}
saveRDS(meddrda_mapping_all, "~/data/MedDRA_mapping_llt_pt_soc.rds" )
```

combine the meddra info the the FARES cases with the medDRA info
```{r}
meddrda_mapping_all$pt_name <- toupper(meddrda_mapping_all$pt_name)
meddrda_mapping_all$llt_name <- toupper(meddrda_mapping_all$llt_name)

index<- as.data.frame(matrix(nrow= nrow(FARES), ncol = 7))
colnames(index)<-  c("llt_id", "llt_name", "pt_id", "pt_name", "soc_id", "soc_name", "soc_short")
for( i in 1:nrow(FARES) ){ #nrow(FARES)
# determine if it is a lower level term or perffered term 
 
  test_term <- FARES[i,8] %in% meddrda_mapping_all$pt_name
  
  #if it perffered term match this way
  if(test_term == TRUE){
    #sec1<- c() 
    sec2_num <- grep(FARES[i,8],meddrda_mapping_all$pt_name, fixed = TRUE )[1]
    sec2<- meddrda_mapping_all[sec2_num, 4:8]
    item <- c(NA , NA , as.character(sec2))
    #print(item)
  }
  #some term don't match for either 
  if(FARES[i,8] %in% meddrda_mapping_all$llt_name){
  #if it is lower level term match this way
    item<- as.vector(meddrda_mapping_all[FARES[i,8] == meddrda_mapping_all$llt_name, c(1:2, 4:8)])
    #print(item)
  }else{
    item <- rep(NA, 7)
  }
  #colnames(index)<- NULL 
  #names(item)<- NULL
  #rownames(index) <- NULL
  #print(length(item))
  #print(i)
  if ( ! is.na(as.vector(item)[3]) ){
    suppressWarnings(index[i,]<- as.vector(item))
  }
}
```


```{r}
FARES_AE<- cbind(FARES, index)
colnames(FARES_AE) <- c("case_number", "year_Q", "sex", "age" , "number_drugs", "serious" , "drug"  , 
                          "AE_FARES", "llt_id", "llt_name", "pt_id", "pt_name", "soc_id", "soc_name", "soc_short")
saveRDS(FARES_AE, "~/data/220727_FARES_subset_test_set.rds")
```
developed this section of code into a function MedDRA_AE_mapping

```{r}
test_example <- MedDRA_AE_mapping(FARES[1:5,])
```


create a data frame with just case info 
```{r}
FARES_cases <- FARES[,1:6]
# it is duplicated because of the combination of drug and side effects
FARES_cases<- FARES_cases[!duplicated(FARES_cases),]
```
in the future save this file 


```{r}
#the AE_mapping from the sex differences pandemic paper are not complete
#library(readr)
#AE_mapping <- read_delim("data/AE_mapping.csv", delim = "\t", escape_double = FALSE, trim_ws = TRUE)
#check if the PT_name is unique
#identical(length(AE_mapping$PT_name),length(unique(AE_mapping$PT_name)))

#length(unique(FARES$Var2[!FARES$Var2 %in% toupper(AE_mapping$PT_name)]))
#unique(FARES$Var2[!FARES$Var2 %in% toupper(AE_mapping$PT_name)])
```



### Analysis

look at the cases:
  how many cases 
```{r}
dim(FARES_cases)
```

  how many cases for each sex 
```{r}
table(FARES_cases$sex)
```

  how many serious vs not serious cases (1= bad and 2= less serious)
```{r}
table(FARES_cases$serious)
```

  how many cases are serious vs not serious between the sexes
```{r}
sex_serious_df <- as.data.frame(table(FARES_cases[,c(3,6)]))
sex_serious_df
```

```{r}
sex_serious_df$sex <- ifelse(sex_serious_df$sex == "M", "Male", "Female")
sex_serious_df$serious <- ifelse(sex_serious_df$serious == 1 , "serious", "less serious")
```


```{r}

ggplot(sex_serious_df, aes(fill=serious, y=Freq, x= sex)) + 
    geom_bar(position="stack", stat="identity") +
    theme_classic()+
    xlab("Sex") +
    ylab("Count")+
    labs(fill= "Adverse Event")+
    scale_fill_viridis(discrete = T) + 
    theme(axis.ticks = element_blank())+
    ggtitle("Sex and serious reports in FARES") 
#ggsave("./output/FARES_plots/220722_sex_serious_FARES.pdf")
```
```{r}
ggplot(sex_serious_df, aes(fill=serious, y=Freq, x= sex)) + 
    geom_bar(position="fill", stat="identity") +
    theme_classic()+
    xlab("Tissue") +
    ylab("Fraction")+
    scale_fill_viridis(discrete = T) + 
    theme(axis.ticks = element_blank())+
    ggtitle("Sex and serious reports in FARES") 
#ggsave("./output/FARES_plots/220722_sex_serious_FARES_percent.pdf")
```

```{r}
FARES_cases$age <- as.numeric(FARES_cases$age)
FARES_cases$number_drugs<- as.numeric(FARES_cases$number_drugs)
```

```{r}
hist(FARES_cases$age)
```

```{r}
hist(FARES_cases$number_drugs)
```

create a scatterplot of age and number of drugs with the point with serious and not serious 
```{r}
ggplot(FARES_cases,  aes( y=number_drugs, x= age) ) +
#  geom_point() +
  geom_hex(bins = 70) +
  scale_fill_continuous(type = "viridis")
```
odd I would assume older the more number of drugs (maybe because adverse events??)

```{r}
ggplot(FARES_cases,  aes( y=number_drugs, x= age) ) +
#  geom_point() +
  geom_hex(bins = 70) +
  scale_fill_continuous(type = "viridis") + facet_wrap(~serious)
```
```{r}
ggplot(FARES_cases,  aes( y=number_drugs, x= age) ) +
#  geom_point() +
  geom_hex(bins = 70) +
  scale_fill_continuous(type = "viridis") + facet_wrap(~sex)
```


  looking at the serious cases:
```{r}
FARES_cases_serious<- FARES_cases[FARES_cases$serious == 1, ]
```
    age between sexes 
```{r}
#FARES_cases_serious
ggplot(FARES_cases_serious,  aes( y=age, x= sex, fill= sex) ) +
  geom_violin() +  scale_fill_viridis_d()  
```
    
    number of drugs

```{r}
#FARES_cases_serious
ggplot(FARES_cases_serious,  aes( y=number_drugs, x= sex, fill= sex) ) +
  geom_violin() +  scale_fill_viridis_d()  
```

I can also look at reporting year and number via facet wrap

looking at the adverse events
```{r}
FARES_AE_only <- FARES_AE[, -7]
FARES_AE_only <- FARES_AE_only[!duplicated(FARES_AE_only),]
```

```{r}
FARES_AE_only_ser<- FARES_AE_only[FARES_AE_only$serious == 1, ]
```

```{r}
sex_ae_serious_df <- as.data.frame(table(FARES_AE_only_ser[,c(3,13)]))
sex_ae_serious_df
```
```{r}
ggplot(sex_ae_serious_df, aes(fill=sex, x=Freq, y= soc_name)) + 
    geom_bar(position="fill", stat="identity") +
    theme_classic()+
    ylab("System Organ Class") +
    xlab("Fraction")+
    scale_fill_viridis(discrete = T) + 
    theme(axis.ticks = element_blank())+
    ggtitle("Sex and Adverse event System Organ Class in FARES") 
#ggsave("./output/FARES_plots/220722_sex_serious_FARES_percent.pdf")
```



looking at the drugs


### Save Data
### Save Figures
    
# END
    Location of final scripts:
    
    Location of data produced:
    
    Dates when operations were done:
    
## Versions
```{r}
sessionInfo()
```

